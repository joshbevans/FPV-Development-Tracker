@page "/AddCompletedRun"
@using FPVDevelopment.Components.Data.Classes
@using FPVDevelopment.Components.Data.Models
@using FPVDevelopment.Components.Globals
@using static FPVDevelopment.Components.Globals.Enums
@inject CompletedRunService completedRunService;
@inject MapService mapService;
@inject DroneService droneService;
@inject CurrentUser currentUser;
@rendermode InteractiveServer

<h1>Add a completed run to the database.</h1>

<EditForm FormName="AddCompletedRunForm" Model="@completedRun" OnSubmit="HandleSubmit">
    <label for="MapInput">Select Map: </label>
    <InputSelect id="MapInput" @bind-Value="@completedRun.Map">
        @foreach (Map map in mapList)
        {
            string displayTag = $"{map.Name} ({map.Difficulty})";
            <option value="@map">@displayTag</option>
        }
    </InputSelect>
    <br /><br />

    <label for="DroneInput">Select Drone: </label>
    <InputSelect id="DroneInput" @bind-Value="@completedRun.Drone">
        @foreach (Drone drone in droneList)
        {
            string displayTag = $"{drone.Name} ({Enums.GetEnumDescription(drone.Size)})";
            <option value="@drone">@displayTag</option>
        }
    </InputSelect>
    <br /><br />

    <label>Input Time: </label>
    <input type="number" @bind="minutes">
    <input type="number" @bind="seconds">
    <input type="number" @bind="milliseconds">
    <br /><br />

    <label for="CrashInput">Number of Crashes / Resets: </label>
    <InputNumber id="CrashInput" @bind-Value="@completedRun.CrashCount"></InputNumber>
    <br /><br />

    <button type="submit" class="btn-outline-primary" disabled="@_isSubmitDisabled">Add Completed Run</button>
</EditForm>

@code {
    CompletedRun completedRun = new CompletedRun();
    List<Map> mapList = new List<Map>();
    List<Drone> droneList = new List<Drone>();
    private int minutes;
    private int seconds;
    private int milliseconds;
    private TimeSpan CreateTimeSpan() => new TimeSpan(0, 0, minutes, seconds, milliseconds);

    protected override async Task OnInitializedAsync()
    {
        mapList = await mapService.GetMaps();
        droneList = await droneService.GetDrones();
        currentUser.CurrentUserChangedEvent += OnCurrentUserChanged;
    }

    private void OnCurrentUserChanged(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        currentUser.CurrentUserChangedEvent -= OnCurrentUserChanged;
    }

    private bool _isSubmitDisabled =>
        false;
        // completedRun.Drone is null ||
        // completedRun.Map is null ||
        // completedRun.CrashCount is null;

    public void HandleSubmit(EditContext editContext)
    {
        CompletedRun newCompletedRun = (CompletedRun)editContext.Model;
        newCompletedRun.Time = CreateTimeSpan(); 
        completedRunService.AddCompletedRun(newCompletedRun, currentUser.User);
    }
}